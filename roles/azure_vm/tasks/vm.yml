---
# Build vm_identity_param only when MSI is enabled

- name: Set vm_identity for SystemAssigned
  when:
    - enable_msi | bool
    - (msi_type | lower) == 'systemassigned'
  ansible.builtin.set_fact:
    vm_identity_param:
      type: "SystemAssigned"

- name: Set vm_identity for UserAssigned
  when:
    - enable_msi | bool
    - (msi_type | lower) == 'userassigned'
  ansible.builtin.set_fact:
    vm_identity_param:
      type: "UserAssigned"
      user_assigned_identities:
        id: "{{ msi_uai_ids | default([]) }}"
        append: "{{ msi_append | default(true) }}"

- name: Set vm_identity for Both
  when:
    - enable_msi | bool
    - (msi_type | lower) == 'both'
  ansible.builtin.set_fact:
    vm_identity_param:
      type: "SystemAssigned, UserAssigned"
      user_assigned_identities:
        id: "{{ msi_uai_ids | default([]) }}"
        append: "{{ msi_append | default(true) }}"

# (Optional) quick debug to confirm the payload built as expected
# - name: Show vm_identity_param
#   ansible.builtin.debug:
#     var: vm_identity_param

- name: Create Linux VM (password auth)
  when: os_type | lower == "linux"
  azure.azcollection.azure_rm_virtualmachine:
    resource_group: "{{ resource_group }}"
    name: "{{ vm_name }}"
    location: "{{ location }}"
    vm_size: "{{ vm_size }}"
      #network_interfaces: ["{{ nic_name }}"]
    network_interface_names:
      - "{{ nic_result.state.id }}"
    admin_username: "{{ admin_username }}"
    admin_password: "{{ admin_password }}"
    ssh_password_enabled: "{{ ssh_password_enabled | default(true) }}"
    image:
      offer: "{{ image.offer }}"
      publisher: "{{ image.publisher }}"
      sku: "{{ image.sku }}"
      version: "{{ image.version }}"
    managed_disk_type: "{{ os_disk_type }}"
    data_disks: "{{ data_disks | default([]) }}"
    vm_identity: "{{ vm_identity_param | default(omit) }}"
    tags: "{{ base_tags | combine(vm_tags | default({})) }}"
  no_log: false



# ---- WINDOWS VM ----
- name: Create Windows VM (password auth)
  when: os_type | lower == "windows"
  azure.azcollection.azure_rm_virtualmachine:
    resource_group: "{{ resource_group }}"
    name: "{{ vm_name }}"
    location: "{{ location }}"
    vm_size: "{{ vm_size }}"
    network_interface_names:
      - "{{ nic_result.state.id }}"
    # Windows-specific flag
    os_type: "Windows"
    # Auth
    admin_username: "{{ admin_username }}"
    admin_password: "{{ admin_password }}"
    # For Windows, azure_rm_virtualmachine handles local admin/password.
    # Enable WinRM in your post-provision steps if you need config management.
    # Image from roles/azure_vm/vars/windows.yml
    image:
      offer: "{{ image.offer }}"
      publisher: "{{ image.publisher }}"
      sku: "{{ image.sku }}"
      version: "{{ image.version }}"
    # Disks
    managed_disk_type: "{{ os_disk_type }}"
    data_disks: "{{ data_disks | default([]) }}"
    # Managed Identity (optional)
    vm_identity: "{{ vm_identity_param | default(omit) }}"
    # Tags
    tags: "{{ base_tags | combine(vm_tags | default({})) }}"
  no_log: false
